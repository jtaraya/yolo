---
- name: Update apt cache
  apt:
    update_cache: yes

- name: Install system packages
  apt:
    name:
      - git
      - curl
      - docker-compose
      - python3-pip
    state: present

- name: Install Docker Python module
  pip:
    name: docker
    state: present

- name: Ensure Docker service is running
  service:
    name: docker
    state: started
    enabled: yes

- name: Create app directory
  file:
    path: "{{ app_base_dir }}"
    state: directory
    owner: vagrant
    group: vagrant
    mode: "0755"

- name: Add vagrant user to docker group
  user:
    name: vagrant
    groups: docker
    append: yes

- name: Clone application repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_base_dir }}/src"
    version: HEAD
    force: yes
  become: yes

- name: Create Docker networks
  become: yes
  block:
    - name: Create backend-db-net
      community.docker.docker_network:
        name: backend-db-net
        driver: bridge
        state: present

    - name: Create frontend-backend-net
      community.docker.docker_network:
        name: frontend-backend-net
        driver: bridge
        state: present